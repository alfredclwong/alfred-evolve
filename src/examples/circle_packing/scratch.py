# %%
import numpy as np
import matplotlib.pyplot as plt
from pathlib import Path

# %%
root_dir = Path(__file__).parent.parent.parent.parent
program_db_path = root_dir / "data" / "flash.db"
program_db_path.exists()

# %%
from alfred_evolve.database.base import Program, Score
from alfred_evolve.database.sql import SQLDatabase

sql_db = SQLDatabase(f"sqlite:///{program_db_path}")

with sql_db.get_session() as session:
    n_islands = session.query(Program.island_id).distinct().count()
print(f"Number of islands in the database: {n_islands}")

initial_program_content = sql_db.get(
    Program, filter_by={"island_id": 0}, order_by="id"
).content
print(f"Initial program content:\n{initial_program_content}")

with sql_db.get_session() as session:
    from sqlalchemy.orm import aliased

    ParentProgram = aliased(Program)
    migration_ids = (
        session.query(Program.id)
        .join(ParentProgram, Program.parent)
        .filter(Program.island_id != ParentProgram.island_id)
        .all()
    )
print(f"Migration IDs: {migration_ids}")

for migration_id in migration_ids:
    program = sql_db.get(Program, filter_by={"id": migration_id[0]})
    scores = sql_db.get_n(Score, filter_by={"program_id": program.id}, order_by="name")
    print(
        f"Program ID: {program.id}, Island ID: {program.island_id}, Scores: {scores}, Parent ID: {program.parent_id}"
    )
    if program.parent_id:
        parent_program = sql_db.get(Program, filter_by={"id": program.parent_id})
        parent_scores = sql_db.get_n(
            Score, filter_by={"program_id": parent_program.id}, order_by="name"
        )
        print(
            f"Parent Program ID: {parent_program.id}, Island ID: {parent_program.island_id}, Scores: {parent_scores}"
        )

sql_db.close()

# %%
packing = np.array(
    [
        [0.22523074260709577, 0.2601379158433056, 0.09090820966774142],
        [0.7437745570127853, 0.9015418216696667, 0.09806493597234768],
        [0.35615954231426145, 0.402280652685667, 0.10169409792752977],
        [0.9055847791249405, 0.0944152208750595, 0.09403812610531805],
        [0.8751206422552624, 0.7212417333140906, 0.12438058909051258],
        [0.720474022219875, 0.39510146182282385, 0.10222582455876855],
        [0.3194995192773371, 0.6112221496890418, 0.10967212326084735],
        [0.8972296445741988, 0.2911581869277485, 0.10235989021525184],
        [0.5362836658746589, 0.3077195406314405, 0.101028376994318],
        [0.47159494511034844, 0.7270619910172629, 0.08093259174092197],
        [0.1156651790038558, 0.7074317726564925, 0.11520321181636935],
        [0.30776963385732714, 0.8661638419782307, 0.1333016158714196],
        [0.3025243872816582, 0.09304018243228428, 0.09266857957158206],
        [0.10512447759172296, 0.10512447759172296, 0.10470461000782882],
        [0.38310629742413804, 0.23335200460070252, 0.06875842700781461],
        [0.13100078776829052, 0.4613241870147643, 0.13047757009807184],
        [0.7103767565154766, 0.17536236911182895, 0.11689273204054201],
        [0.5424789505909069, 0.8969369788207784, 0.10265138706048284],
        [0.7376650889157197, 0.5737887828430739, 0.07665986977513566],
        [0.5405885181314067, 0.53343488957587, 0.12386786359024067],
        [0.6516601016113148, 0.7271552158748111, 0.09859638497624938],
        [0.8981282461249916, 0.4957243038350637, 0.10146487768264639],
        [0.06750018842288413, 0.2733829384810455, 0.06723059240038988],
        [0.08941776219797025, 0.9105822378020297, 0.08906062729816992],
        [0.49992657544463864, 0.10485754024918739, 0.10443873881410681],
        [0.9204001259182004, 0.9204001259182004, 0.07928195186639694],
    ]
)

# %%
packing = np.array(
    [
        [0.716444630297887, 0.2192688095543205, 0.09681549977305469],
        [0.8913612361845853, 0.3270767010801281, 0.10831317333162109],
        [0.6735403885328922, 0.6832887478586616, 0.1394008490359589],
        [0.7273338603642775, 0.06137839248790285, 0.061194441384238206],
        [0.2558027761274346, 0.8020169799805615, 0.08736119890060155],
        [0.5191004458596832, 0.28598229484624754, 0.11099854298819514],
        [0.37289360199824423, 0.11428381851155114, 0.1139413097931882],
        [0.5648285486083648, 0.8985804680460852, 0.10111557751522944],
        [0.24610506085434616, 0.9445523814924954, 0.05528144193939],
        [0.3815770917560595, 0.9170581789419523, 0.08269324433739494],
        [0.10434857958802947, 0.5026963003634427, 0.10403584679065557],
        [0.6933746956489537, 0.4296675035361324, 0.11426309424069667],
        [0.1297102169988951, 0.1297102169988951, 0.1293214753488392],
        [0.0986099796545559, 0.9013900203454441, 0.09831444544692122],
        [0.28156260406369465, 0.34443649916895913, 0.13304343321225182],
        [0.4722930287121599, 0.5150650452080546, 0.12216767675250433],
        [0.2741411003444274, 0.615552505221525, 0.09948819771754233],
        [0.0979828035998633, 0.7048686804503898, 0.09768914903949172],
        [0.4363554730157546, 0.7385657225909453, 0.10356546292412432],
        [0.7633048821364349, 0.902697398653693, 0.09701098535276946],
        [0.0746229349612526, 0.3262922361423967, 0.07439928995055078],
        [0.8870840622615518, 0.5485282537907826, 0.11257752856013015],
        [0.5774530835243712, 0.09168224105122369, 0.09140746928311093],
        [0.9290873517029071, 0.9290873517029071, 0.0707001230192338],
        [0.8907383226749832, 0.10926167732501683, 0.10893421996881207],
        [0.9000766157264404, 0.76089630382726, 0.09962391379096833],
    ]
)

# %%
packing = np.array(
    [
        [0.7164448396474888, 0.21927008743111434, 0.09680907884251473],
        [0.8913613842066292, 0.3270786948408202, 0.10838943020702646],
        [0.6735420065683454, 0.6832900039606336, 0.13942379040945724],
        [0.7273332489090567, 0.061378357285823845, 0.06116192428976864],
        [0.2558034922064482, 0.8020157898250968, 0.08735314980740402],
        [0.5191014403215154, 0.2859838281775013, 0.11110245030882504],
        [0.3728938294918523, 0.1142844128196899, 0.11396570411604097],
        [0.5648300434899164, 0.8985802581233362, 0.10120150461936882],
        [0.24610544110036153, 0.944552206178098, 0.055250343683721476],
        [0.38157778425938954, 0.9170575873848533, 0.0827486909202013],
        [0.10434647440621128, 0.5026964531360553, 0.10414117025404826],
        [0.6933762144333612, 0.42966910975062456, 0.11424328231517436],
        [0.12971071871564943, 0.12971071871564943, 0.12939907798201464],
        [0.09861063662584457, 0.9013893633741554, 0.09830884688500584],
        [0.2815631605022282, 0.34444076288468284, 0.13305413962689647],
        [0.47229708325214015, 0.5150659742804082, 0.12232961570894223],
        [0.2741419753930281, 0.6155478466377556, 0.0994493842993396],
        [0.09798305799875891, 0.7048669188400958, 0.09774718757289007],
        [0.43635697738823537, 0.7385653382395192, 0.10365884704075928],
        [0.7633058177063254, 0.902698204112115, 0.09696987402072056],
        [0.07462275410501232, 0.3262943753336292, 0.07441814807860711],
        [0.8870843720848518, 0.5485305925287506, 0.11268057682516623],
        [0.5774531455310877, 0.09168248646519675, 0.0914931060592971],
        [0.9290877810525555, 0.9290877810525555, 0.07073370533996176],
        [0.8907378641770134, 0.10926213582298658, 0.10895385312834517],
        [0.9000773009521404, 0.760898070744081, 0.09967809018860836],
    ]
)

# %%
packing = np.array(
    [
        [0.7163194417555738, 0.21924096418811642, 0.09694950813389738],
        [0.8913786740728802, 0.32707206220672064, 0.10851564606696126],
        [0.673370869610267, 0.6833197307855959, 0.13967951625001426],
        [0.7272141658105329, 0.06130699229891364, 0.061238089979877175],
        [0.2557432806254209, 0.8022079559464994, 0.08739327023001116],
        [0.518943363241943, 0.28590776198501344, 0.11119299157042581],
        [0.37284344253976487, 0.1141935161086054, 0.11407354055617337],
        [0.5646779746603628, 0.8986292929085171, 0.10128027908733701],
        [0.24606764598105177, 0.9446595102726667, 0.05527720028041115],
        [0.3814441272110705, 0.9171437680170947, 0.08277977177818029],
        [0.10452593540984328, 0.5027584657232954, 0.10443011222802083],
        [0.6931997790947123, 0.4296486976204918, 0.11448335685204367],
        [0.1296234900706487, 0.1296234900706487, 0.1294959062215702],
        [0.09852072189276162, 0.9014792781072384, 0.09842028653054735],
        [0.28149667548364216, 0.3440906964803873, 0.1330623469959756],
        [0.4718622912111389, 0.515086425273961, 0.12258013148944003],
        [0.27404452737210144, 0.6161226151714932, 0.09937019665977555],
        [0.09791330670006672, 0.7050698921757502, 0.09781864035094931],
        [0.43616903036719556, 0.7387278429315347, 0.10370216099642873],
        [0.7632106231078365, 0.902728494756868, 0.09714995853187168],
        [0.07457728911995115, 0.32620424644272633, 0.07450822108662393],
        [0.8870920370949207, 0.5485391325462871, 0.11280207028487663],
        [0.5773671061799941, 0.0916259711137256, 0.09154328043391159],
        [0.9291395158904877, 0.9291395158904877, 0.0708050086137609],
        [0.8907601059020849, 0.10923989409791514, 0.10912942938271654],
        [0.9001015558197247, 0.7609226309601981, 0.09979292007243636],
    ]
)

# %%
packing = np.array(
    [[0.7163319118496715, 0.2192438297833181, 0.09698109258468267], [0.891450898763756, 0.3270725206888314, 0.10851427506324399], [0.673388249981219, 0.6833167866058857, 0.1396966182286816], [0.7272261651511488, 0.06125688036106441, 0.0612528637796348], [0.25574939640338673, 0.8021887500987315, 0.08743211588598053], [0.5189590851418376, 0.28591520385639796, 0.11118940581994873], [0.3728486469008471, 0.11417372483045161, 0.11408832004204537], [0.5646934857933213, 0.8986410568814939, 0.10127425570253104], [0.24607140591440366, 0.9447041304464777, 0.055295851052182994], [0.381457669079626, 0.9171641079487356, 0.08278203669907327], [0.10444640926998953, 0.5027522935756484, 0.10440357101571081], [0.6932175144605938, 0.42965063097259726, 0.11450122377451441], [0.12957162850123094, 0.129600348896591, 0.1295026489618334], [0.09844741068326265, 0.9014839545529868, 0.09843115202998583], [0.2815032726597942, 0.34412530119879275, 0.13311343265540143], [0.47190571596393455, 0.5150841930032592, 0.12254685920616577], [0.27405435020855806, 0.6160652723984038, 0.09942126132874049], [0.09784447154826315, 0.7050496516684401, 0.09782236115380424], [0.436187984194329, 0.7387114918223654, 0.10370456083910118], [0.763220430365145, 0.9027435247078834, 0.09717729126813665], [0.07450772209465932, 0.3262133256000516, 0.07450725868391758], [0.887157243506055, 0.5485380018427568, 0.11279577664655721], [0.577375767877939, 0.09159705994317789, 0.09153982173140994], [0.9292040059717871, 0.9291715162197429, 0.07079480622506275], [0.8908375511211427, 0.10922574359064845, 0.1091328597304215], [0.9001636768836364, 0.760920071130161, 0.09980089971054817]]
)
print(packing[:, 2].sum())

# %%
def plot_packing(packing):
    fig, ax = plt.subplots(figsize=(8, 8))
    ax.set_xlim(0, 1)
    ax.set_ylim(0, 1)
    ax.set_aspect("equal")

    for x, y, r in packing:
        circle = plt.Circle((x, y), r, edgecolor="black", facecolor="none")
        ax.add_artist(circle)

    plt.title("Circle Packing")
    ax.set_xticks([])
    ax.set_yticks([])
    ax.set_xlabel("")
    ax.set_ylabel("")
    plt.grid(False)
    plt.show()


# %%
plot_packing(packing)

# %%
